/// @title ERC1363 Payable token
/// @notice SPDX-License-Identifier: MIT
/// @author 0x4non
/// @notice Some ideas were taken from Solmate, Solady and Huffmate

#include "../ERC20/main.huff"

// Interface

#define function approveAndCall(address,uint256,bytes) nonpayable returns ()
#define function transferAndCall(address,uint256,bytes) nonpayable returns ()

// Events
#define event Approval(address indexed, address indexed, uint256)
#define event Transfer(address, address, uint256)

// Errors
#define error InsufficientBalance()
#define error InsufficientAllowance()

#define constant ADDRESS_MASK = 0xffffffffffffffffffffffffffffffffffffffff

#define macro TRANSFER_AND_CALL(z0) = takes(0) returns(0) {
    // takes:                      []
    0x20                        // [0x20]
    __FUNC_SIG("onTransferReceived(address,address,uint256,bytes)")    // [0x20, SIG_onTransferReceived]
    0xe0                        // [0x20, SIG_onTransferReceived, 0xe0]
    shl                         // [0x20, shiftedFunctionSig]
    <z0>                        // [0x20, shiftedFunctionSig, z0]
    0x20                        // [0x20, shiftedFunctionSig, z0, 0x20]
    <z0>                        // [0x20, shiftedFunctionSig, z0, 0x20, z0]
    0x60                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, 0x60]
    calldatasize                // [0x20, shiftedFunctionSig, z0, 0x20, z0, 0x60, calldatasize()]
    add                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60)]
    <z0>                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0]
    <z0>                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0]
    [ADDRESS_MASK]              // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK]
    0x4                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK, 0x4]
    calldataload                // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK, calldataload(0x4)]
    and                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to]
    0x80                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80]
    caller                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller()]
    0x24                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24]
    caller                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller()]
    0x4                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4]
    dup13                       // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig]
    <z0>                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0]
    0x44                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, 0x44]
    calldatasize                // [..., shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, 0x44, calldatasize()]
    sub                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44)]
    0x44                        // [..., shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44]
    dup10                       // [..., z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to]
    caller                      // [..., 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller()]
    __EVENT_HASH(Transfer)
    //                             [..., z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE]
    0x20                        // [..., add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20]
    0x44                        // [..., z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44]
    0x24                        // [..., z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, 0x24]
    calldataload                // [..., z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount]
    dup1                        // [..., to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount]
    dup7                        // [..., 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to]
    dup3                        // [..., caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to, amount]
    caller                      // [..., 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to, amount, caller()]
    sload                       // [..., 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to, amount, senderBalance]
    SAFE_SUB_ERR(<z0>, 0xf4d678b8)
    //                             [..., caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to, newSenderBalance]
    caller                      // [..., 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to, newSenderBalance, caller()]
    sstore                      // [..., 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, to]
    sload                       // [..., 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, amount, sload(to)]
    add                         // [..., to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, add(sload(to), amount)]
    dup7                        // [..., 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, add(sload(to), amount), to]
    sstore                      // [..., z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount]
    0x44                        // [..., to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44, amount, 0x44]
    mstore                      // [..., z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, to, caller(), _TRANSFER_EVENT_SIGNATURE, 0x20, 0x44]
    log3                        // [..., shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44]
    0x64                        // [..., z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0, sub(calldatasize(), 0x44), 0x44, 0x64]
    calldatacopy                // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4, shiftedFunctionSig, z0]
    mstore                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24, caller(), 0x4]
    mstore                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x24]
    mstore                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80]
    0x64                        // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, 0x64]
    mstore                      // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to]
    gas                         // [0x20, shiftedFunctionSig, z0, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, gas()]
    call                        // [0x20, shiftedFunctionSig, z0, callOk]
    _REQUIRE(<z0>, 0x85b16394)  // [0x20, shiftedFunctionSig, z0]
    mload                       // [0x20, shiftedFunctionSig, ret]
    eq                          // [0x20, eq(ret, shiftedFunctionSig)]
    0x1                         // [0x20, eq(ret, shiftedFunctionSig), 0x1]
    <z0>                        // [0x20, eq(ret, shiftedFunctionSig), 0x1, z0]
    mstore                      // [0x20, eq(ret, shiftedFunctionSig)]
    _REQUIRE(<z0>, 0x85b16394)  // [0x20]
    <z0>                        // [0x20, z0]
    return                      // []
    // returns:                    []
}
#define macro TRANSFER_FROM_AND_CALL(z0) = takes(0) returns(0) {
    // takes:                      []
    0x1                         // [0x1]
    __FUNC_SIG("onTransferReceived(address,address,uint256,bytes)")    // [0x1, SIG_onTransferReceived]
    0xe0                        // [0x1, SIG_onTransferReceived, 0xe0]
    shl                         // [0x1, shiftedFunctionSig]
    0x20                        // [0x1, shiftedFunctionSig, 0x20]
    <z0>                        // [0x1, shiftedFunctionSig, 0x20, z0]
    0x60                        // [0x1, shiftedFunctionSig, 0x20, z0, 0x60]
    calldatasize                // [0x1, shiftedFunctionSig, 0x20, z0, 0x60, calldatasize()]
    add                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60)]
    <z0>                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0]
    <z0>                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0]
    [ADDRESS_MASK]              // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK]
    0x4                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK, 0x4]
    calldataload                // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, ADDRESS_MASK, calldataload(0x4)]
    and                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to]
    0x80                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80]
    caller                      // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller()]
    dup9                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig]
    0x4                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4]
    calldatasize                // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize()]
    0x44                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), 0x44]
    calldataload                // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount]
    dup7                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to]
    [ADDRESS_MASK]              // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, ADDRESS_MASK]
    0x4                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, ADDRESS_MASK, 0x4]
    calldataload                // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, ADDRESS_MASK, calldataload(0x4)]
    and                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from]
    dup3                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount]
    dup2                        // [..., shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, from]
    dup5                        // [..., 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, from, amount]
    caller                      // [..., z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, from, amount, caller()]
    dup5                        // [..., add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, from, amount, caller(), from]
    _USE_ALLOWANCE(<z0>)        // [..., shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, from]
    sload                       // [..., shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, amount, fromBalance]
    SAFE_SUB_ERR(<z0>, 0xf4d678b8)
    //                             [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, newFromBalance]
    dup2                        // [..., shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from, newFromBalance, from]
    sstore                      // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize(), amount, to, from]
    _TRANSFER_FROM(<z0>, 0x44)  // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, 0x4, calldatasize()]
    sub                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, sub(calldatasize(), 0x4)]
    0x4                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, sub(calldatasize(), 0x4), 0x4]
    0x24                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, sub(calldatasize(), 0x4), 0x4, 0x24]
    calldatacopy                // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig]
    <z0>                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), shiftedFunctionSig, z0]
    mstore                      // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller()]
    0x4                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, caller(), 0x4]
    mstore                      // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80]
    0x64                        // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, 0x80, 0x64]
    mstore                      // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to]
    gas                         // [0x1, shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x60), z0, z0, to, gas()]
    call                        // [0x1, shiftedFunctionSig, callOk]
    _REQUIRE(<z0>, 0x85b16394)  // [0x1, shiftedFunctionSig]
    <z0>                        // [0x1, shiftedFunctionSig, z0]
    mload                       // [0x1, shiftedFunctionSig, ret]
    eq                          // [0x1, eq(ret, shiftedFunctionSig)]
    _REQUIRE(<z0>, 0x85b16394)  // [0x1]
    <z0>                        // [0x1, z0]
    mstore                      // []
    0x20                        // [0x20]
    <z0>                        // [0x20, z0]
    return                      // []
    // returns:                    []
}
#define macro APPROVE_AND_CALL(z0) = takes(0) returns(0) {
    // takes:                      []
    0x4                         // [0x4]
    calldataload                // [spender]
    0x24                        // [spender, 0x24]
    calldataload                // [spender, amount]
    dup2                        // [spender, amount, spender]
    caller                      // [spender, amount, spender, caller()]
    GET_SLOT_FROM_KEYS(<z0>)    // [spender, amount, slot]
    dup3                        // [spender, amount, slot, spender]
    _APPROVE_SET_AMOUNT_AND_LOG()
    //                             [spender, amount, slot]
    sstore                      // [spender]
    _APPROVE_HOOK(<z0>)         // []
    0x1                         // [0x1]
    <z0>                        // [0x1, z0]
    mstore                      // []
    0x20                        // [0x20]
    <z0>                        // [0x20, z0]
    return                      // []
    // returns:                    []
}

#define macro _APPROVE_HOOK(z0) = takes(1) returns(0) {
    // takes:                      [spender]
    0x20                        // [spender, 0x20]
    <z0>                        // [spender, 0x20, z0]
    0x40                        // [spender, 0x20, z0, 0x40]
    calldatasize                // [spender, 0x20, z0, 0x40, calldatasize()]
    add                         // [spender, 0x20, z0, add(calldatasize(), 0x40)]
    <z0>                        // [spender, 0x20, z0, add(calldatasize(), 0x40), z0]
    <z0>                        // [spender, 0x20, z0, add(calldatasize(), 0x40), z0, z0]
    __FUNC_SIG("onApprovalReceived(address,uint256,bytes)")    // [spender, 0x20, z0, add(calldatasize(), 0x40), z0, z0, SIG_onApprovalReceived]
    0xe0                        // [spender, 0x20, z0, add(calldatasize(), 0x40), z0, z0, SIG_onApprovalReceived, 0xe0]
    shl                         // [spender, 0x20, z0, add(calldatasize(), 0x40), z0, z0, shiftedFunctionSig]
    swap6                       // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender]
    gas                         // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas()]
    caller                      // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), caller()]
    0x4                         // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), caller(), 0x4]
    dup10                       // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), caller(), 0x4, shiftedFunctionSig]
    <z0>                        // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), caller(), 0x4, shiftedFunctionSig, z0]
    mstore                      // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), caller(), 0x4]
    mstore                      // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas()]
    0x60                        // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), 0x60]
    0x44                        // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas(), 0x60, 0x44]
    mstore                      // [shiftedFunctionSig, 0x20, z0, add(calldatasize(), 0x40), z0, z0, spender, gas()]
    call                        // [shiftedFunctionSig, callOk]
    _REQUIRE(<z0>, 0x81cbe4db)  // [shiftedFunctionSig]
    <z0>                        // [shiftedFunctionSig, z0]
    mload                       // [shiftedFunctionSig, ret]
    eq                          // [eq(ret, shiftedFunctionSig)]
    _REQUIRE(<z0>, 0x81cbe4db)  // []
    // returns:                    []
}

#define macro _APPROVE_SET_AMOUNT_AND_LOG() = takes(1) returns(0) {
    // takes:                      [spender]
    0x24                        // [spender, 0x24]
    calldatasize                // [spender, 0x24, calldatasize()]
    sub                         // [spender, sub(calldatasize(), 0x24)]
    0x24                        // [spender, sub(calldatasize(), 0x24), 0x24]
    0x24                        // [spender, sub(calldatasize(), 0x24), 0x24, 0x24]
    calldatacopy                // [spender]
    caller                      // [spender, caller()]
    __EVENT_HASH(Approval)
    //                             [spender, caller(), _APPROVAL_EVENT_SIGNATURE]
    0x20                        // [spender, caller(), _APPROVAL_EVENT_SIGNATURE, 0x20]
    0x24                        // [spender, caller(), _APPROVAL_EVENT_SIGNATURE, 0x20, 0x24]
    log3                        // []
    // returns:                    []
}
