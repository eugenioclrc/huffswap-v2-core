// SPDX-License-Identifier: MIT
pragma solidity 0.8.25;

import {Ownable} from "solady/auth/Ownable.sol";
import {SafeTransferLib} from "solady/utils/SafeTransferLib.sol";
import {CREATE3} from "solady/utils/CREATE3.sol";

/**
 * @author taken from https://github.com/LatamSwap/latamswap-dex
 */
contract HuffSwapFactory is Ownable {
    using SafeTransferLib for address;

    error ErrZeroAddress();
    error ErrIdenticalAddress();
    error ErrPairExists();
    error ErrNativoMustBeDeployed();

    /// @dev Maps tokens to its pair
    mapping(address fromToken => mapping(address toToken => address pair)) public getPair;
    /// @dev Stores all created pairs
    address[] public allPairs;

    /// @dev Event emitted when a new pair is created
    event PairCreated(address indexed token0, address indexed token1, address pair, uint256 allPairsLength);

    /// @dev Initializes the owner of the contract
    constructor(address _owner) {
        _initializeOwner(_owner);
    }

    function getCreationCode(address token0, address token1) internal view returns (bytes memory r) {
        r = abi.encodePacked(
            hex"38600b3d39600b38033df334611fd157343560e01c8063022c0d9f146101cd5780636a627842106100ea57806323b872dd10610095578063095ea7b310610065578063095ea7b31461077257806301ffc9a7146106a657806306fdde031461070557630902f1ac14610722576101c0565b806323b872dd146108995780631296ee62146107b657806318160ddd1461087b57630dfe1681146106d2576101c0565b80634000aea0106100c5578063313ce5671461095a5780633177029f1461096357634000aea0146107b6576101c0565b80636a62784214610a345780635909c0d5146109f857635a3d549314610a16576101c0565b8063bc25cf771061016057806389afcb441061013057806389afcb441461121a5780636a62784214610a3457806370a08231146111f157637464fc3d146111fc576101c0565b8063bc25cf77146119c457806395d89b411461193b578063a9059cbb146119545763ba9a7a5614611fc7576101c0565b8063d8fbe994106101a6578063c1d34b8914611ba2578063d21220a7146106e3578063cae9ca5114610963578063d8fbe99414611ba25763c45a0155146106f4576101c0565b8063dd62ed3e14611cbd5763fff6cae914611cd4576101c0565b63d5cf065534526004601cfd5b602435807401000000000000000000000000000000000000000260027401000000000000000000000000000000000000000554106102125763ab143c0634526004601cfd5b6002740100000000000000000000000000000000000000055554806dffffffffffffffffffffffffffff16600435848173ffffffffffffffffffffffffffffffffffffffff60443516876060868660405286108860701c6dffffffffffffffffffffffffffff1698848c891761028f576342301c2334526004601cfd5b80602060403803343934511490602060203803343934511417156102ba5763290fa18834526004601cfd5b60e01c9a8911166102d25763bb55fd2734526004601cfd5b528282826020604038033439345182156103275782828291906fa9059cbb00000000000000000000000034526014526034523460446010346020945af1600134511417610326576390b8ec1834526004601cfd5b5b5050508160206020380334393451821561037c5782828291906fa9059cbb00000000000000000000000034526014526034523460446010346020945af160013451141761037b576390b8ec1834526004601cfd5b5b505050608435156103c25782828291601c9150336084360360846080376310d1e85c345260205260806080525036343434945af16103c157637fd1918d34526004601cfd5b5b50505030602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa61040257633dd8248734526004601cfd5b345130602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa61044157633dd8248734526004601cfd5b3451918184909190038082039110348218021894828590919003808203911034821802189584848484929190936dffffffffffffffffffffffffffff85116dffffffffffffffffffffffffffff8511156104a2576335278d1234526004601cfd5b156104b4576335278d1234526004601cfd5b420363ffffffff168282821717156105c9577401000000000000000000000000000000000000000454818284866e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1602740100000000000000000000000000000000000000035401740100000000000000000000000000000000000000035584846e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16020174010000000000000000000000000000000000000004555b50505081819060701b4260e01b1717740100000000000000000000000000000000000000025534526020527f1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1604034a18586861761062e5763098fb56134526004601cfd5b853452602052604435337fd78ad95fa46c994b6551d0da85fc275fe613ce37657fb8d5e3d130840159d822608034a394600302906103e80203926003029102620f424002926103e80203021161068b576335b01a0f34526004601cfd5b60017401000000000000000000000000000000000000000555005b60043560e01c6336372b0781146301ffc9a782141781637d4c6ff5149163b0202a111417173452602034f35b602060403803343934513452602034f35b602060203803343934513452602034f35b602060603803343934513452602034f35b6f0f48756666537761702050616972563260203452602f52606034f35b74010000000000000000000000000000000000000002548060701c6dffffffffffffffffffffffffffff168160e01c916dffffffffffffffffffffffffffff166060838234528360205260405234f35b6020600134600435602435348183336020523452604034205552337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925602034a35234f35b6020600173ffffffffffffffffffffffffffffffffffffffff600435166024358133823354908103908111156107f35763f4d678b834526004601cfd5b3384604452557fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60206044a38154018155346020346060360134346388a7ca5c60e01b965a608060643360048c6044360360446064373452523360245252f1610863576385b1639434526004601cfd5b5114610876576385b1639434526004601cfd5b345234f35b60207401000000000000000000000000000000000000000054345234f35b600160443573ffffffffffffffffffffffffffffffffffffffff6024351673ffffffffffffffffffffffffffffffffffffffff600435168233826020523452604034208054908134191461090457828290810390811115610901576313be252b34526004601cfd5b81555b5050509091808254908103908111156109245763f4d678b834526004601cfd5b813452825582540182557fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a33452602034f35b60203460123452f35b6020346001600435337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925602060246024358533602052345260403420868260245234602034604036013434637b04a2d060e01b966060604489604436036044604437345233600452525af16109df576381cbe4db34526004601cfd5b51146109f2576381cbe4db34526004601cfd5b55a33452f35b60207401000000000000000000000000000000000000000354345234f35b60207401000000000000000000000000000000000000000454345234f35b6002740100000000000000000000000000000000000000055410610a5f5763ab143c0634526004601cfd5b6002740100000000000000000000000000000000000000055574010000000000000000000000000000000000000002548060e01c30602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa610ad057633dd8248734526004601cfd5b345130602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa610b0f57633dd8248734526004601cfd5b3451808460701c6dffffffffffffffffffffffffffff16946dffffffffffffffffffffffffffff169385858486929190936dffffffffffffffffffffffffffff85116dffffffffffffffffffffffffffff851115610b74576335278d1234526004601cfd5b15610b86576335278d1234526004601cfd5b420363ffffffff16828282171715610c9b577401000000000000000000000000000000000000000454818284866e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1602740100000000000000000000000000000000000000035401740100000000000000000000000000000000000000035584846e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16020174010000000000000000000000000000000000000004555b50505081819060701b4260e01b1717740100000000000000000000000000000000000000025534526020527f1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1604034a184848490810390811115610d0657632a2ab27834526004601cfd5b9290810390811115610d1f57632a2ab27834526004601cfd5b92858574010000000000000000000000000000000000000001548015610f2a578282028070ffffffffffffffffffffffffffffffffff1060071b81811c68ffffffffffffffffff1060061b1781811c64ffffffffff1060051b1781811c62ffffff1060041b1760b582821c62010000019160011c1b0260121c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c80910481119003818070ffffffffffffffffffffffffffffffffff1060071b81811c68ffffffffffffffffff1060061b1781811c64ffffffffff1060051b1781811c62ffffff1060041b1760b582821c62010000019160011c1b0260121c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8091048111900381811015610f275781818160050281019103740100000000000000000000000000000000000000005480158282029284928404141702610ea65763ad251c2734526004601cfd5b046020606038033439345190348183837401000000000000000000000000000000000000000054810190811015610ee4576335278d1234526004601cfd5b74010000000000000000000000000000000000000000555401835552347fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a35b50505b505050808202918183049115348218021814610f4d576335278d1234526004601cfd5b7401000000000000000000000000000000000000000183833452602052337f4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f604034a2557401000000000000000000000000000000000000000054806110f85791808202918183049115348218021814610fce576335278d1234526004601cfd5b8070ffffffffffffffffffffffffffffffffff1060071b81811c68ffffffffffffffffff1060061b1781811c64ffffffffff1060051b1781811c62ffffff1060041b1760b582821c62010000019160011c1b0260121c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c809104811190036103e8810393506103e8349034818383740100000000000000000000000000000000000000005481019081101561109a576335278d1234526004601cfd5b74010000000000000000000000000000000000000000555401835552347fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a36103e8106110f15763bb55fd2734526004601cfd5b5050611158565b9193929082908015828202928492840414170261111c5763ad251c2734526004601cfd5b04928015828202928492840414170261113c5763ad251c2734526004601cfd5b048181109082180218806111575763bb55fd2734526004601cfd5b5b80345260043590348183837401000000000000000000000000000000000000000054810190811015611191576335278d1234526004601cfd5b74010000000000000000000000000000000000000000555401835552347fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a360017401000000000000000000000000000000000000000555602034f35b602060043554345234f35b60207401000000000000000000000000000000000000000154345234f35b74010000000000000000000000000000000000000002600274010000000000000000000000000000000000000005541061125b5763ab143c0634526004601cfd5b6002740100000000000000000000000000000000000000055554305430602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa6112b457633dd8248734526004601cfd5b34519030602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa6112f457633dd8248734526004601cfd5b34518360701c6dffffffffffffffffffffffffffff16846dffffffffffffffffffffffffffff166004359560e01c9282827401000000000000000000000000000000000000000154801561152d578282028070ffffffffffffffffffffffffffffffffff1060071b81811c68ffffffffffffffffff1060061b1781811c64ffffffffff1060051b1781811c62ffffff1060041b1760b582821c62010000019160011c1b0260121c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c80910481119003818070ffffffffffffffffffffffffffffffffff1060071b81811c68ffffffffffffffffff1060061b1781811c64ffffffffff1060051b1781811c62ffffff1060041b1760b582821c62010000019160011c1b0260121c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c8082040160011c809104811190038181101561152a57818181600502810191037401000000000000000000000000000000000000000054801582820292849284041417026114a95763ad251c2734526004601cfd5b0460206060380334393451903481838374010000000000000000000000000000000000000000548101908110156114e7576335278d1234526004601cfd5b74010000000000000000000000000000000000000000555401835552347fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a35b50505b5050507401000000000000000000000000000000000000000054809186801582820292849284041417026115685763ad251c2734526004601cfd5b049585801582820292849284041417026115895763ad251c2734526004601cfd5b049385851761159f5763749383ad34526004601cfd5b3034918034528181740100000000000000000000000000000000000000005403740100000000000000000000000000000000000000005554908103908111156115ef5763f4d678b834526004601cfd5b81557fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034a3848685886020604038033439345191906fa9059cbb00000000000000000000000034526014526034523460446010346020945af1600134511417611661576390b8ec1834526004601cfd5b6020602038033439345191906fa9059cbb00000000000000000000000034526014526034523460446010346020945af16001345114176116a8576390b8ec1834526004601cfd5b9130602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa6116e657633dd8248734526004601cfd5b34519130602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa61172657633dd8248734526004601cfd5b3451938484929190936dffffffffffffffffffffffffffff85116dffffffffffffffffffffffffffff851115611763576335278d1234526004601cfd5b15611775576335278d1234526004601cfd5b420363ffffffff1682828217171561188a577401000000000000000000000000000000000000000454818284866e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1602740100000000000000000000000000000000000000035401740100000000000000000000000000000000000000035584846e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16020174010000000000000000000000000000000000000004555b50505081819060701b4260e01b1717740100000000000000000000000000000000000000025534526020527f1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1604034a1027401000000000000000000000000000000000000000155600174010000000000000000000000000000000000000005553452602052337f3e43e1de00e8a6bc1dfa3e950e6ade24c52e4a25de4dee7fb5affe918ad1e744604034a3604034f35b6b0b48554646535741502d563260203452602b52606034f35b60013473ffffffffffffffffffffffffffffffffffffffff60043516337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602034602435803354908103908111156119b35763f4d678b834526004601cfd5b33558086540186553452a352602034f35b6004358060027401000000000000000000000000000000000000000554106119f35763ab143c0634526004601cfd5b600274010000000000000000000000000000000000000005557401000000000000000000000000000000000000000254806dffffffffffffffffffffffffffff169060701c6dffffffffffffffffffffffffffff1630602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa611a8557633dd8248734526004601cfd5b34519130602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa611ac557633dd8248734526004601cfd5b345190810390811115611adf576335278d1234526004601cfd5b9190810390811115611af8576335278d1234526004601cfd5b926020604038033439345191906fa9059cbb00000000000000000000000034526014526034523460446010346020945af1600134511417611b40576390b8ec1834526004601cfd5b6020602038033439345191906fa9059cbb00000000000000000000000034526014526034523460446010346020945af1600134511417611b87576390b8ec1834526004601cfd5b60017401000000000000000000000000000000000000000555005b602073ffffffffffffffffffffffffffffffffffffffff6024351673ffffffffffffffffffffffffffffffffffffffff6004351660443580338360205234526040342080549081341914611c0d57828290810390811115611c0a576313be252b34526004601cfd5b81555b5050508282835450909180825490810390811115611c325763f4d678b834526004601cfd5b81604452825582540182557fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60206044a390608060646388a7ca5c60e01b93602485346064360360646064375233600452525260203436606001343434955af1611ca3576385b1639434526004601cfd5b5114611cb6576385b1639434526004601cfd5b6001345234f35b602060243560043560205234526040342054345234f35b6002740100000000000000000000000000000000000000055410611cff5763ab143c0634526004601cfd5b600274010000000000000000000000000000000000000005557401000000000000000000000000000000000000000254806dffffffffffffffffffffffffffff16908060701c6dffffffffffffffffffffffffffff169060e01c9130602060403803343934519060146f70a0823100000000000000000000000034525234602460106020935afa611d9757633dd8248734526004601cfd5b345180611dab5763bb55fd2734526004601cfd5b30602060203803343934519060146f70a0823100000000000000000000000034525234602460106020935afa611de857633dd8248734526004601cfd5b34519081611dfd5763bb55fd2734526004601cfd5b929190936dffffffffffffffffffffffffffff85116dffffffffffffffffffffffffffff851115611e35576335278d1234526004601cfd5b15611e47576335278d1234526004601cfd5b420363ffffffff16828282171715611f5c577401000000000000000000000000000000000000000454818284866e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1602740100000000000000000000000000000000000000035401740100000000000000000000000000000000000000035584846e010000000000000000000000000000027bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16047bffffffffffffffffffffffffffffffffffffffffffffffffffffffff16020174010000000000000000000000000000000000000004555b50505081819060701b4260e01b1717740100000000000000000000000000000000000000025534526020527f1c411e9a96e071241c2f21f7726b17ae89e3cab4c78be50e062b03a9fffbbad1604034a160017401000000000000000000000000000000000000000555005b6103e83452602034f35b636fb1b0e96000526004601cfd",
            abi.encode(address(this), token0, token1)
        );
    }

    /// @dev Returns the total number of pairs.
    /// @return Total number of pairs.
    function allPairsLength() external view returns (uint256) {
        return allPairs.length;
    }

    function _createPair(address token0, address token1) internal returns (address pair) {
        // @dev sortTokens will revert if any address is 0 or address are identical
        (token0, token1) = sortTokens(token0, token1);

        bytes memory creationCode = getCreationCode(token0, token1);

        pair = CREATE3.deploy(keccak256(abi.encodePacked(token0, token1)), creationCode, 0);

        getPair[token0][token1] = pair;
        getPair[token1][token0] = pair; // populate mapping in the reverse direction
        allPairs.push(pair);
        emit PairCreated(token0, token1, pair, allPairs.length);
    }

    /**
     * @dev Creates a new pair with two tokens.
     * @param tokenA The address of the first token.
     * @param tokenB The address of the second token.
     * @return pair The address of the newly created pair.
     * @notice Tokens must be different and not already have a pair.
     */
    function createPair(address tokenA, address tokenB) external returns (address pair) {
        if (getPair[tokenA][tokenB] != address(0)) revert ErrPairExists(); // single check is sufficient
        pair = _createPair(tokenA, tokenB);
    }

    function getOrCreatePair(address tokenA, address tokenB) external returns (address pair) {
        pair = getPair[tokenA][tokenB];
        if (pair == address(0)) {
            pair = _createPair(tokenA, tokenB);
        }
    }

    /**
     * @dev Allows the owner to withdraw the entire balance of a specific token.
     * @param token The token to withdraw.
     * @param to The recipient address.
     */
    function withdraw(address token, address to) external onlyOwner {
        token.safeTransferAll(to);
    }

    /**
     * @dev Allows the owner to withdraw a specified amount of a specific token.
     * @param token The token to withdraw.
     * @param to The recipient address.
     * @param amount The amount of tokens to withdraw.
     */
    function withdraw(address token, address to, uint256 amount) external onlyOwner {
        token.safeTransfer(to, amount);
    }

    // returns sorted token addresses, used to handle return values from pairs sorted in this order
    function sortTokens(address tokenA, address tokenB) internal pure returns (address token0, address token1) {
        if (tokenA == tokenB) revert ErrIdenticalAddress();
        (token0, token1) = tokenA < tokenB ? (tokenA, tokenB) : (tokenB, tokenA);
        if (token0 == address(0)) revert ErrZeroAddress();
    }
}
